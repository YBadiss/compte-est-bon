<!doctype html>
<html>
  <style>
    .content {
      max-width: 500px;
      margin: auto;
    }
    .content * {
      font-size: x-large;
    }
  </style>
  <head>
    <title>This is the title of the webpage!</title>
  </head>
  <body>
    <div class="content">
      <p>Target: <span id="targetValue"></span><img src="refresh.png" style="width: 20px; height: 20px; float: right;" onclick="refresh()"></p>
      <p><span id="operators"></span><div id="selectedValues"></div></p>
      <p id="solutionSteps"></p>
      <div id="success" style="width: 200px; height: 200px; overflow: hidden;" hidden>
        <img src="success.gif" style="margin: -50px 0 0 -150px">
      </div>
      <p><button id="solutionBtn" onclick="loseGame()">I give up...</button><div id="solution" hidden></div></p>
    </div>
    <script>


let ops = [add, sub, mul, div];
let signs = ["+", "-", "*", "/"];
let values = [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 25, 50, 75, 100];
let selectedValues = [];
let operands = [];
let operandIds = [[]];
let numOperations = -1;
let targetValue = 0;
let nextTargetStep = 1;
let nextTargetDirection = -1;
let worker = null;

function add(a, b) { return a + b; }
function mul(a, b) { return (a != 1 && b != 1) ? a * b : null; }
function sub(a, b) { return (a > b) ? a - b : null; }
function div(a, b) { return (a % b == 0 && b != 1) ? a / b : null; }
function getRandomInt(max) {
  return Math.floor(Math.random() * Math.floor(max));
}

//========================================================================================

let solutionDiv = document.getElementById("solution");
let successGif = document.getElementById("success");
let solutionSteps = document.getElementById("solutionSteps");
document.getElementById("operators").innerHTML = signs.map(o => `<button onclick="useOperator('${o}')">${o}</button>`).join(" ");

function curOpElement() {
  return document.getElementById(`operation${numOperations}`);
}
function useValue(value, id) {
  if (operands.length == 1) {
    removeLastOperation();
    newEmptyOperation();
  }
  else if (operands.length != 0 && operands.length != 2) {
    return;
  }
  let opElement = curOpElement();

  operands.push(value);
  operandIds[numOperations].push(id);
  opElement.innerHTML = opElement.innerHTML + ` ${value} `;
  document.getElementById(id).disabled = true;

  if (operands.length == 3) {
    let result = ops[signs.indexOf(operands[1])](operands[0], operands[2]);
    if (!!result) {
      opElement.innerHTML = opElement.innerHTML + ` = <button id="result${numOperations}" onclick="useValue(${result}, 'result${numOperations}')">${result}</button> <img src="delete.gif" style="width: 15px; height: 15px;" onclick="cancelOperation(${numOperations})"><br>`;
      if (result == targetValue) {
        winGame();
      }
    } else {
      removeLastOperation();
    }
    newEmptyOperation();
  }
}
function useOperator(operator) {
  if (operands.length == 0) {
    if (numOperations == 0) {
      return;
    } else {
      let id = `result${numOperations - 1}`;
      let resultButton = document.getElementById(id);
      let value = parseInt(resultButton.textContent);
      useValue(value, id);
    }
  } else if (operands.length == 2) {
    let value = operands[0];
    let id = operandIds[numOperations][0];
    operands.pop();
    useValue(value, id);
  }
  operands.push(operator);
  let opElement = curOpElement();
  opElement.innerHTML = opElement.innerHTML + ` ${operator} `;
}
function removeLastOperation() {
  let opElement = curOpElement();
  solutionSteps.removeChild(opElement);
  operandIds[numOperations].forEach(id => document.getElementById(id).disabled = false);
  operandIds.pop();
  numOperations = numOperations - 1;
}
function newEmptyOperation() {
  numOperations = numOperations + 1;
  let newOpElement = document.createElement("span");
  newOpElement.id = `operation${numOperations}`;
  solutionSteps.appendChild(newOpElement);
  operandIds.push([]);
  operands = [];
}
function cancelOperation(operationId) {
  while (numOperations >= operationId) {
    removeLastOperation();
  }
  newEmptyOperation();
}

function endGame(result) {
  if (localStorage.games.length > 0) {
    let lastGame = localStorage.games[localStorage.games.length - 1];
    if (!lastGame.end) { lastGame.end = Date.now(); }
    if (!lastGame.result) { lastGame.result = result ? result : "skip"; }
    localStorage.games[localStorage.games.length - 1] = lastGame;
  }
}

function winGame() {
  endGame("win");
  successGif.hidden = false;
}

function loseGame() {
  endGame("lose");
  solutionDiv.hidden = false;
}

//========================================================================================
function refresh() {
  endGame();
  cancelOperation(0);
  values = [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 25, 50, 75, 100];
  selectedValues = [];
  successGif.hidden = true;
  solutionDiv.hidden = true;

  while (selectedValues.length < 6) {
    let selectedIndex = getRandomInt(values.length);
    selectedValues.push(values.splice(selectedIndex, 1)[0]);
  }
  targetValue = getRandomInt(900) + 100;
  nextTargetStep = 1;
  nextTargetDirection = -1;

  document.getElementById("selectedValues").innerHTML = selectedValues.map((v, i) => `<button id="selectedValue${i}" onclick="useValue(${v}, 'selectedValue${i}')">${v}</button>` ).join(", ");
  document.getElementById("targetValue").textContent = targetValue;
  solutionDiv.innerHTML = "";

  if (!!worker) {
    worker.terminate();
  }
  worker = new Worker('worker.js');
  worker.onmessage = function(e) {
    let solution = e.data;
    let solutionText = !!solution ? solution.join("<br>") : `No solution for ${targetValue}!`;
    solutionDiv.innerHTML = solutionDiv.innerHTML + "<br>" + solutionText;

    if (!solution) {
      targetValue = targetValue + (nextTargetStep * nextTargetDirection);
      nextTargetStep = nextTargetStep + 1;
      nextTargetDirection = nextTargetDirection * -1;
      worker.postMessage(selectedValues.concat([targetValue]))
    } else {
      document.getElementById("targetValue").textContent = targetValue;

      localStorage.games.push({
        targetValue: targetValue,
        selectedValues: selectedValues,
        start: Date.now(),
        end: null,
        result: null,
      });
    }
  };
  worker.postMessage(selectedValues.concat([targetValue]));
}

//========================================================================================

if (!localStorage.games) {
  localStorage.games = [];
}

//========================================================================================

refresh();
    </script>
  </body>
</html>
